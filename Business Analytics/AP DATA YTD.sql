--SQL Queries to get the source and count of Accounts Payable Invoices
--FEED_Non_PO_Invoices
SELECT VENDOR_CODE as "Vendor Code", COMPANY_NAME as "Supplier Name", TO_CHAR( creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( creation_date, 'YYYY-MM' ) "Year", COUNT(1) as "Count of <>PO AP via Feed" FROM (SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in(SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and a.po_reference is null minus SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and nvl(b.uses_supplier_portal_for,0) not in (2,3)  and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is null and nvl(a.is_deleted, 0) != '1' and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and nvl(c.is_deleted, 0) != '1' and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number) minus SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number and (c.creation_user in (select FTP_FOR from pbeach.csv_ftp_detail where subscriber_id=641 and ftp_upload_dir like '%ereceive%'))) minus SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in(SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and not exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number)) GROUP BY VENDOR_CODE, COMPANY_NAME, TO_CHAR(creation_date, 'MON-YY' ) , TO_CHAR( creation_date, 'YYYY-MM' ) ORDER BY 4;
--FEED_PO_Invoices 
SELECT VENDOR_CODE as "Vendor Code", COMPANY_NAME as "Supplier Name", TO_CHAR( creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( creation_date, 'YYYY-MM' ) "Year",COUNT(1) as "Count of PO AP via Feed" FROM (SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in(SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and a.po_reference is not null minus SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and nvl(b.uses_supplier_portal_for,0) not in (2,3) and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is not null and nvl(a.is_deleted, 0) != '1' and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and nvl(c.is_deleted, 0) != '1' and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number) minus SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is not null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number and (c.creation_user in (select FTP_FOR from pbeach.csv_ftp_detail where subscriber_id=641 and ftp_upload_dir like '%ereceive%'))) minus SELECT a.AP_INVOICE_NUMBER,a.SUPPLIER_COMPANY_ID,a.VENDOR_CODE,b.company_name,a.creation_date FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is not null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in(SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and not exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number)) GROUP BY VENDOR_CODE, COMPANY_NAME  ,TO_CHAR(creation_date, 'MON-YY' ) , TO_CHAR( creation_date, 'YYYY-MM' ) ORDER BY 4;
--PO_Supplier_Portal_Invoices 
SELECT a.VENDOR_CODE as "Vendor Code", b.company_name as "Supplier Name", TO_CHAR( a.creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( a.creation_date, 'YYYY-MM' ) "Year",COUNT(1) as "PO Supplier Portal Invoices" FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and nvl(b.uses_supplier_portal_for,0) not in (2,3) and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is not null and nvl(a.is_deleted, 0) != '1' and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and nvl(c.is_deleted, 0) != '1' and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number) GROUP BY a.VENDOR_CODE, b.company_name ,TO_CHAR(a.creation_date, 'MON-YY' ) , TO_CHAR( a.creation_date, 'YYYY-MM' ) ORDER BY 4;
--Non_PO_Supplier_Portal_Invoices
SELECT a.VENDOR_CODE as "Vendor Code", b.company_name as "Supplier Name",TO_CHAR( a.creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( a.creation_date, 'YYYY-MM' ) "Year", COUNT(1) as "PO Supplier Portal Invoices" FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and nvl(b.uses_supplier_portal_for,0) not in (2,3) and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is null and nvl(a.is_deleted, 0) != '1' and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and nvl(c.is_deleted, 0) != '1' and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number) GROUP BY a.VENDOR_CODE, b.company_name ,TO_CHAR(a.creation_date, 'MON-YY' ) , TO_CHAR( a.creation_date, 'YYYY-MM' ) ORDER BY 4;
--PO_eReceiveInvoices 
SELECT a.VENDOR_CODE as "Vendor Code", b.company_name as "Supplier Name", TO_CHAR( a.creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( a.creation_date, 'YYYY-MM' ) "Year",COUNT(1) as "PO EInvoice" FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is not null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number and (c.creation_user in (select FTP_FOR from pbeach.csv_ftp_detail where subscriber_id=641 and ftp_upload_dir like '%ereceive%'))) GROUP BY a.VENDOR_CODE, b.company_name ,TO_CHAR(a.creation_date, 'MON-YY' ) , TO_CHAR( a.creation_date, 'YYYY-MM' ) ORDER BY 4;
--Non_PO_eReceiveInvoices 
SELECT a.VENDOR_CODE as "Vendor Code", b.company_name as "Supplier Name", TO_CHAR( a.creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( a.creation_date, 'YYYY-MM' ) "Year",COUNT(1) as "PO EInvoice" FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number and (c.creation_user in (select FTP_FOR from pbeach.csv_ftp_detail where subscriber_id=641 and ftp_upload_dir like '%ereceive%'))) GROUP BY a.VENDOR_CODE, b.company_name ,TO_CHAR(a.creation_date, 'MON-YY' ) , TO_CHAR( a.creation_date, 'YYYY-MM' ) ORDER BY 4;
--Manually_Generated_PO_Invoices_Non_Electronic 
SELECT a.VENDOR_CODE as "Vendor Code", b.company_name as "Supplier Name", TO_CHAR( a.creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( a.creation_date, 'YYYY-MM' ) "Year",COUNT(1) as "Manually Gen PO AP/Non-Elect" FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is not null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and not exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number) GROUP BY a.VENDOR_CODE, b.company_name ,TO_CHAR(a.creation_date, 'MON-YY' ) , TO_CHAR( a.creation_date, 'YYYY-MM' ) ORDER BY 4;
--Manually_Generated_NON_PO_Invoices_Non_Electronic 
SELECT a.VENDOR_CODE as "Vendor Code", b.company_name as "Supplier Name", TO_CHAR( a.creation_date, 'MON-YY' ) "Exception Month", TO_CHAR( a.creation_date, 'YYYY-MM' ) "Year",COUNT(1) as "Manually Gen <>PO AP" FROM PBEACH.APINVOICE_HEADER a, PBEACH.PSM_COMPANY_PROFILE b WHERE a.SUBSCRIBER_ID = 641 and a.SUBSCRIBER_ID = b.subscriber_id and a.supplier_company_id = b.company_id and a.po_reference is null and a.creation_date between TO_DATE('2021-01-01', 'YYYY-MM-DD') and TO_DATE('2022-03-01', 'YYYY-MM-DD') and a.company_id in (SELECT COMPANY_ID FROM PBEACH.PSM_COMPANY_PROFILE WHERE SUBSCRIBER_ID = 641 and is_buyer = 1 and active = 1 and BATTR_VAL15 is not null) and nvl(a.is_deleted, 0) != '1' and not exists (SELECT 1 FROM PBEACH.SUPP_INVOICE_HEADER c WHERE c.SUBSCRIBER_ID = 641 and a.subscriber_id = c.subscriber_id and a.ap_invoice_number = c.ap_invoice_number) and not exists (SELECT 1 FROM PBEACH.STG_IN_DOCUDATA_INVOICE d WHERE d.SUBSCRIBER_ID = 641 and a.subscriber_id = d.subscriber_id and a.ap_invoice_number = d.ap_invoice_number) GROUP BY a.VENDOR_CODE, b.company_name ,TO_CHAR(a.creation_date, 'MON-YY' ) , TO_CHAR( a.creation_date, 'YYYY-MM' ) ORDER BY 4;
